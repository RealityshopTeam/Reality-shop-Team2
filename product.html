<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Product Details - Reality Shop</title>
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/* ... all your existing CSS ... */
.star-rating,
.star-rating.readonly { font-size: 1.7rem; unicode-bidi: bidi-override; direction: rtl;}
.star-rating > span { color: #ff9800; display: inline-block; position: relative; cursor: pointer; transition: color 0.2s;}
.star-rating > span.inactive { color: #ddd;}
.star-rating > span.selected { color: #ffa500 !important;}
.star-rating.readonly > span { cursor: default;}
.rating-value { font-size: 1rem; color: #ff9800; margin-left: 10px; font-weight: 600;}
.rating-count { color: #666; font-size:0.95rem; margin-left:6px;}
</style>
</head>
<body>
<!-- NAV and LAYOUT unchanged... -->
  <nav>
    <div class="nav-container">
      <a href="index.html" class="logo">Reality Shop</a>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="shop.html" class="active">Shop</a></li>
        <li><a href="cart.html">Cart</a></li>
        <li><a href="wishlist.html">Wish list</a></li>
        <li><a href="login.html">Account</a></li>
      </ul>
    </div>
  </nav>
  <div class="page-container">
    <section class="product-details" id="product-details"></section>
    <aside class="related-products" id="related-products">
      <h3>Related Products</h3>
    </aside>
  </div>
<script>
const products = [
  {name: "Samsung s22 ultra", price: 65999, glb: "imgs/samsung_galaxy_s22_ultra.glb", category: "Mobile"},
  {name: "Poco x3", price: 15999, glb: "imgs/poco_x3_nfc.glb", category: "Mobile"},
  {name: "Blue T-shirt", price: 499, img: "imgs/Ts.jpg", category: "Clothing"},
  {name: "Plain Shirt", price: 450, img: "imgs/short.jpg", category: "Clothing"},
  {name: "Sun Glass", price: 299, glb: "imgs/sunglas.glb", category: "Accessories"}
];

function getQueryParam(param) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(param);
}
function getWishlist() {
  return JSON.parse(localStorage.getItem('wishlist') || '[]');
}
function setWishlist(wishlist) {
  localStorage.setItem('wishlist', JSON.stringify(wishlist));
}
function isWishlisted(name) {
  return getWishlist().some(item => item.name === name);
}

// ----------- RATING Storage Helpers ------------
function getProductRatings(name) {
  // In full site use user ID or session; here use localStorage by name
  return JSON.parse(localStorage.getItem("ratings-"+name) || "[]");
}
function setProductRatingValue(name, value) {
  let ratings = getProductRatings(name);
  // Overwrite user's own previous (simulate single-user mode);
  ratings = ratings.filter(r=>!(r && r.me));
  ratings.push({val: value, me:true, ts: Date.now()});
  localStorage.setItem("ratings-"+name, JSON.stringify(ratings));
}
function getProductAvgRating(name) {
  const ratings = getProductRatings(name).map(r=>+r.val);
  if (!ratings.length) return 0;
  return ratings.reduce((p,c)=>p+c,0)/ratings.length;
}
function getMyProductRating(name) {
  const ratings = getProductRatings(name);
  const mine = ratings.filter(r => r.me).pop();
  return mine ? +mine.val : 0;
}
function getProductRatingCount(name) {
  return getProductRatings(name).length;
}

// ---------- RATING STAR RENDERERS -------------
function renderRatingStars(ratingVal, rootEl, submitCB, readonly=false) {
  rootEl.innerHTML = '';
  for (let i = 1; i <= 5; i++) {
    const span = document.createElement('span');
    span.className = 'fa fa-star' + (i <= Math.round(ratingVal) ? '' : ' inactive');
    if (!readonly && submitCB) {
      span.onclick = e => { submitCB(i); };
      span.onmouseover = () => {
        // Preview highlight
        Array.from(rootEl.children).forEach((sp, idx) =>
          sp.classList.toggle('selected', idx < i));
      }
      span.onmouseleave = () => {
        Array.from(rootEl.children).forEach((sp, idx) =>
          sp.classList.remove('selected'));
      }
    }
    rootEl.appendChild(span);
  }
}

// ----------- MAIN PRODUCT PART ---------------
function displayProduct(product) {
  const container = document.getElementById('product-details');
  if (!product) {
    container.innerHTML = `<p>Product not found.</p>`;
    return;
  }
  const arButtonHtml = (["Furniture", "Clothing", "Accessories"].includes(product.category) && product.glb)
    ? `<button class="ar-button" onclick="openARViewer('${encodeURIComponent(product.glb)}')">View in AR</button>` : '';
  const canTryOnAvatar = ["Clothing", "Accessories"].includes(product.category);
  const tryOnHtml = (canTryOnAvatar && (product.img || product.glb))
    ? `<button class="tryon-button" onclick="openTryOn('${encodeURIComponent(product.name)}','${product.img ? encodeURIComponent(product.img) : ""}','${product.glb ? encodeURIComponent(product.glb) : ""}')">Try On Avatar</button>` : '';
  container.innerHTML = `
    ${product.glb ? `
      <model-viewer 
        src="${product.glb}" alt="${product.name} 3D model" 
        camera-controls auto-rotate shadow-intensity="1" 
        style="width:100%; height:500px; border-radius:8px;" 
        id="main-model" 
        interaction-prompt="auto">
        <button slot="ar-button" id="fullscreen-btn" title="Toggle Fullscreen" style="
          position: absolute; bottom: 12px; right: 12px; 
          background: rgba(0,0,0,0.5); color: white; border: none; 
          border-radius: 30px; padding: 10px 16px; cursor: pointer; z-index: 10;">
          ⛶
        </button>
      </model-viewer>
    ` : product.img ? `
      <img src="${product.img}" alt="${product.name}" style="width:100%; height:500px; object-fit: contain; border-radius:8px;">
    ` : ''}
    <div class="product-info">
      <h1>${product.name}</h1>
      <div class="buttons-row">
        <button class="btn-main" id="add-cart-btn">Add to Cart</button>
        <button class="wishlist-btn ${isWishlisted(product.name) ? 'active' : ''}" id="wishlist-btn">
          ${isWishlisted(product.name) ? "Wishlisted" : "Add to Wishlist"}
        </button>
        ${arButtonHtml}
        ${tryOnHtml}
      </div>
      <p class="price">₹${product.price}.00</p>
      <div id="avgRatingWrap">
        <div style="display:flex;align-items:center;">
          <div class="star-rating" id="avgStarDisplay"></div>
          <span class="rating-value" id="avgRatingNum"></span>
          <span class="rating-count" id="ratingCount"></span>
        </div>
        <div style="margin-top:5px;">
          <div style="font-size:1rem;">Your rating:</div>
          <div class="star-rating" id="starInput"></div>
        </div>
      </div>
      <p style="margin-bottom:16px;">${product.info || ''}</p>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aenean euismod bibendum laoreet. Proin gravida dolor sit amet lacus accumsan.</p>
    </div>
  `;
  // Render average stars
  function renderLiveRatings() {
    const avg = getProductAvgRating(product.name) || 0;
    const cnt = getProductRatingCount(product.name) || 0;
    renderRatingStars(avg, document.getElementById("avgStarDisplay"), null, true);
    document.getElementById("avgRatingNum").textContent = avg ? avg.toFixed(1) + "/5" : "-";
    document.getElementById("ratingCount").textContent = "(" + cnt + " ratings)";
    // Render input stars
    const mine = getMyProductRating(product.name);
    renderRatingStars(mine, document.getElementById("starInput"), val => {
      setProductRatingValue(product.name, val);
      renderLiveRatings();
    }, false);
  }
  renderLiveRatings();

  document.getElementById('add-cart-btn').onclick = () => {
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    let existing = cart.find(item => item.name === product.name);
    if(existing) existing.quantity += 1;
    else cart.push({name: product.name, price: product.price, quantity: 1});
    localStorage.setItem('cart', JSON.stringify(cart));
    alert(product.name + " added to cart!");
  };
  document.getElementById('wishlist-btn').onclick = function() {
    if(isWishlisted(product.name)) return;
    let wishlist = getWishlist();
    wishlist.push({
      name: product.name, price: product.price, category: product.category,
      img: product.img, glb: product.glb
    });
    setWishlist(wishlist);
    this.classList.add('active');
    this.textContent = "Wishlisted";
  };
  if (product.glb) {
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const modelViewer = document.getElementById('main-model');
    fullscreenBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      if (!document.fullscreenElement) modelViewer.requestFullscreen();
      else document.exitFullscreen();
    });
  }
}
// RELATED PRODUCTS — shows average rating only
function displayRelated(product) {
  const container = document.getElementById('related-products');
  container.innerHTML = `<h3>Related Products</h3>`;
  const related = products.filter(p => p.category === product.category && p.name !== product.name);
  (related.length ? related : products.filter(p => p.name !== product.name).slice(0, 4)).forEach(p => {
    const row = document.createElement('div');
    row.className = 'related-product-row';
    const avg = getProductAvgRating(p.name) || (Math.random() * 2 + 3); // fallback "average"
    row.innerHTML = `
      <div class="related-thumb">
        ${p.glb ? `<model-viewer src="${p.glb}" alt="${p.name}" camera-controls auto-rotate shadow-intensity="1"></model-viewer>`
        : p.img ? `<img src="${p.img}" alt="${p.name}">`
        : `<div style="width:100px;height:100px;background:#eee;line-height:100px;text-align:center;">No Image</div>`}
      </div>
      <div class="related-info" style="flex:1 1 0;">
        <h4>${p.name}</h4>
        <div class="price">₹${p.price}.00</div>
        <div class="rating">${"★".repeat(Math.round(avg))}${"☆".repeat(5-Math.round(avg))} (${avg.toFixed(1)}/5)</div>
        <div class="category">${p.category || ''}</div>
        <p>${p.info ? p.info : ''}</p>
      </div>
    `;
    row.onclick = () => window.location.href = `product.html?name=${encodeURIComponent(p.name)}`;
    container.appendChild(row);
  });
}
function openARViewer(modelPath) {
  window.open(`ar-view.html?model=${modelPath}`, '_blank');
}
function openTryOn(name, img, glb) {
  let url = `avatar.html?name=${name}`;
  if (img) url += `&img=${img}`;
  if (glb) url += `&glb=${glb}`;
  window.open(url, '_blank');
}
window.onload = () => {
  const productName = decodeURIComponent((new URLSearchParams(window.location.search)).get('name') || "");
  const product = products.find(p => p.name === productName);
  displayProduct(product);
  if (product) displayRelated(product);
};
</script>
</body>
</html>
