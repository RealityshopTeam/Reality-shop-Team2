<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reality Shop - Universal AR View</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background: black;
    }
    #fallbackContainer {
      display: none;
      width: 100%; height: 100%;
      position: relative;
    }
    video#cameraFeed {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      z-index: 0;
    }
    canvas#threeCanvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 1;
    }
    .instructions {
      position: absolute;
      bottom: 10px;
      width: 100%;
      text-align: center;
      font-weight: bold;
      color: white;
      background: rgba(0,0,0,0.4);
      padding: 8px;
      z-index: 2;
    }
    #arContainer {
      width: 100%; height: 100%;
    }
  </style>
</head>
<body>
  <!-- WebXR AR (real) -->
  <div id="arContainer">
    <model-viewer
      id="arModelViewer"
      src="chair.glb"
      alt="3D Furniture Model"
      ar
      ar-modes="scene-viewer quick-look webxr"
      camera-controls
      auto-rotate
      shadow-intensity="1"
      environment-image="neutral"
      ar-scale="auto"
      interaction-prompt="tap-to-place"
      style="width:100%; height:100%;"
    ></model-viewer>
  </div>

  <!-- Fallback AR (fake) -->
  <div id="fallbackContainer">
    <video id="cameraFeed" autoplay playsinline></video>
    <canvas id="threeCanvas"></canvas>
    <div class="instructions">ðŸ“± Tap/drag to move, pinch to scale furniture.</div>
  </div>

  <!-- Scripts -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/GLTFLoader.js"></script>

  <script>
    const modelViewer = document.getElementById("arModelViewer");
    const fallback = document.getElementById("fallbackContainer");

    // Check if WebXR AR is supported
    if (!("xr" in navigator)) {
      // Hide model-viewer and show fallback
      document.getElementById("arContainer").style.display = "none";
      fallback.style.display = "block";

      const video = document.getElementById('cameraFeed');
      const canvas = document.getElementById('threeCanvas');
      const renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 100);
      camera.position.z = 2;

      const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2);
      scene.add(light);

      // Load GLB furniture
      const loader = new THREE.GLTFLoader();
      let model;
      loader.load("imgs/chair.glb", gltf => {
        model = gltf.scene;
        model.scale.set(0.5, 0.5, 0.5);
        scene.add(model);
      });

      // Camera feed
      async function startCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
          video.srcObject = stream;
        } catch (err) {
          console.error("Camera not available", err);
        }
      }
      startCamera();

      // Gestures
      let lastX, lastY, isDragging = false, scale = 1;
      canvas.addEventListener("touchstart", e => {
        if (e.touches.length === 1) {
          isDragging = true;
          lastX = e.touches[0].clientX;
          lastY = e.touches[0].clientY;
        }
      });
      canvas.addEventListener("touchmove", e => {
        if (model && e.touches.length === 1 && isDragging) {
          let dx = (e.touches[0].clientX - lastX) * 0.01;
          let dy = (e.touches[0].clientY - lastY) * 0.01;
          model.position.x += dx;
          model.position.y -= dy;
          lastX = e.touches[0].clientX;
          lastY = e.touches[0].clientY;
        } else if (model && e.touches.length === 2) {
          // Pinch zoom
          let dx = e.touches[0].clientX - e.touches[1].clientX;
          let dy = e.touches[0].clientY - e.touches[1].clientY;
          let dist = Math.sqrt(dx * dx + dy * dy);
          if (window.lastDist) {
            let diff = dist - window.lastDist;
            scale += diff * 0.002;
            model.scale.set(scale, scale, scale);
          }
          window.lastDist = dist;
        }
      });
      canvas.addEventListener("touchend", () => { isDragging = false; window.lastDist = null; });

      // Render loop
      function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      }
      animate();

      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    }
  </script>
</body>
</html>

